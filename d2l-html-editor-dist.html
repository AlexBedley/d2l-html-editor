<html><head><meta charset="UTF-8"><link rel="import" href="https://polygit2.appspot.com/components/polymer/polymer.html">
<link rel="stylesheet" href="d2l-icons.css">

<!--<link rel="import" href="./vui-input-styles.html">-->

<!--
An element providing a solution to no problem in particular.

Example:

		<d2l-html-editor></d2l-html-editor>

@demo
-->
</head><body><div hidden="" by-vulcanize=""><script type="text/javascript" src="https://s.brightspace.com/lib/ifrau/0.13.1/ifrau/client.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.3.7/tinymce.min.js"></script>
<script>
(function() {
	'use strict';

	function getSelectedNode(editor) {
		var node = null;
		if (editor && editor.selection) {
			node = editor.selection.getNode();
		}

		return node;
	}

	function getSelectionContent(editor) {
		var content = '';
		if (editor && editor.selection) {
			content = tinymce.DOM.decode(editor.selection.getContent());  // eslint-disable-line no-undef
		}
		return content;
	}

	function clearBookmark(editor, bookmark) {
		var selectedNode = getSelectedNode(editor);
		var parentNode = Polymer.dom(selectedNode).parentNode;
		var nodeStart = Polymer.dom(parentNode).querySelector('#' + bookmark.id + '_start');
		if (nodeStart) {
			var nodeStartParent = Polymer.dom(nodeStart).parentNode;
			Polymer.dom(nodeStartParent).removeChild(nodeStart);
		}
		var nodeEnd = Polymer.dom(parentNode).querySelector('#' + bookmark.id + '_end');
		if (nodeEnd) {
			var nodeEndParent = Polymer.dom(nodeEnd).parentNode;
			Polymer.dom(nodeEndParent).removeChild(nodeEnd);
		}

	}

	/** @polymerBehavior */
	var PluginBehavior = {
		getSelectedNode: getSelectedNode,
		getSelectionContent: getSelectionContent,
		clearBookmark: clearBookmark
	};

	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.Plugin = PluginBehavior;

})();
</script>
<script>
/*

Code based on the LMS file:
https://git.dev.d2l/projects/CORE/repos/lp/commits/a5ce570b2719f53a70f1e861d997015ed740a60b
Check that file periodically for changes...

*/

(function() {
	'use strict';

	var regExp = {
		HrefString: '_mce_href=\"[^\"]*\"',
		SrcString: '_mce_src=\"[^\"]*\"',
		OpenScript: '<mce:script',
		CloseScript: '</mce:script>'
	};

	function StringBuilder(initialValue) {
		this.myString = initialValue || '';
	}

	StringBuilder.prototype.Append = function(value) {
		this.myString += value;
	};

	StringBuilder.prototype.ToString = function() {
		return this.myString;
	};

	function getImageClassName(classId) {
		if ( classId !== null ) {
			classId = classId.toLowerCase();
			var guidIndex = classId.indexOf( ':' );
			if ( guidIndex !== -1 && ( classId.length > guidIndex + 1 ) ) {
				classId = classId.substring( guidIndex + 1 );
			}
		} else {
			classId = '';
		}

		switch ( classId ) {
			case 'd27cdb6e-ae6d-11cf-96b8-444553540000':
			case 'application/x-shockwave-flash':
			case 'd2l_flash':
				return 'disf_flash';

			case '166b1bca-3f9c-11cf-8075-444553540000':
				return 'disf_shockwave';

			case '6bf52a52-394a-11d3-b153-00c04f79faa6':
			case '22d6f312-b0f6-11d0-94ab-0080c74c7e95':
			case '05589fa1-c356-11ce-bf01-00aa0055595a':
				return 'disf_windowsmedia';

			case '02bf25d5-8c17-4b23-bc80-d3488abddc6b':
			case 'd2l_qt':
				return 'disf_quicktime';

			case 'cfcdaa03-8be4-11cf-b84b-0020afbbccfa':
				return 'disf_realmedia';

			default:
				return 'disf_default';
		}
	}

	function getAttributeValue(attributeName, html) {
		var attValue = null;
		var attRe = new RegExp( attributeName + '=(\"[^<>"]*\"|\'[^<>\']*\'|\w+)', 'i' );
		var attMatch = attRe.exec( html );
		if ( attMatch !== null && attMatch.length > 1 ) {
			if ( attMatch[1].length > 1 &&
				( attMatch[1].substr( 0, 1 ) === '\'' || attMatch[1].substr( 0, 1 ) === '\"' ) ) {
				attValue = attMatch[1].substring( 1, attMatch[1].length - 1 );
			} else {
				attValue = attMatch[1];
			}
		}
		return attValue;
	}

	function createImage(html) {
		var width = getAttributeValue( 'width', html );
		if ( width === null ) {
			width = '150px';
		}

		var height = getAttributeValue( 'height', html );
		if ( height === null ) {
			height = '150px';
		}

		var classId = getAttributeValue( 'classid', html );
		if ( classId === null ) {
			classId = getAttributeValue( 'type', html );
		}

		// create an image with the encoded content
		return '<img src="/d2l/img/LP/htmlEditor/eq_trans.gif" ' +
			'width="' + width + '" ' +
			'height="' + height + '" ' +
			'class="' + getImageClassName( classId ) + ' d2l-html-editor' + '" ' +
			'data-isf-content="' + encodeURIComponent( html ) + '" />';

	}

	function createElement(html, height, width) {
		if ( width === null ) {
			width = '100px';
		}
		if ( height === null ) {
			height = '100px';
		}

		html = decodeURIComponent( html );

		// remove plugin_href if necessary (clean-up any possible left-over Plugin stuff)
		html = html.replace(
			new RegExp(regExp.HrefString, 'g'),
			''
		);
		html = html.replace(
			new RegExp( regExp.SrcString, 'g'),
			''
		);

		html = html.replace( new RegExp( 'width=[\"\']{1}[0-9px]+[\'\"]', 'gi' ), 'width="' + width + '"' );
		html = html.replace( new RegExp( 'height=[\"\']{1}[0-9px]+[\'\"]', 'gi' ), 'height="' + height + '"' );

		html = html.replace( new RegExp( 'width=[0-9px]+', 'gi' ), 'width=' + width );
		html = html.replace( new RegExp( 'height=[0-9px]+', 'gi' ), 'height=' + height );

		return html;

	}

	function convertToImages(context, isWindowModeOpaque) {
		if ( context.content && context.content.length > 0 &&
			( context.content.search( /(<object|<embed|<iframe)/i ) !== -1 ) ) {

			var html = context.content;
			var sb = new StringBuilder();
			var embedStartRe = new RegExp( '(<embed)', 'i' );
			var objectStartRe = new RegExp( '(<object)', 'i' );
			var iFrameStartRe = new RegExp( '(<iframe)', 'i' );
			var scriptStartRe = new RegExp( '(<script|' + regExp.OpenScript + ')', 'i' );
			var searchRe = new RegExp( '(<object|<embed|<iframe|<script|' + regExp.OpenScript + ')', 'i' );

			var toIndex = 0;
			while ( html.length > 0 ) {

				toIndex = html.search( searchRe );
				if ( toIndex === 0 ) {
					embedStartRe.lastIndex = 0;
					scriptStartRe.lastIndex = 0;
					objectStartRe.lastIndex = 0;
					iFrameStartRe.lastIndex = 0;

					searchRe.lastIndex = toIndex;
					var match = searchRe.exec( html )[0];
					if ( scriptStartRe.test( match ) ) {

						// skip script
						var scriptEndIndex = html.indexOf( '>', toIndex );
						if ( html.substr( scriptEndIndex - 1, 1 ) === '/' ) {
							toIndex = scriptEndIndex + 1;
						} else {
							var scriptEndRe = new RegExp( '(<\/script>|' + regExp.CloseScript + ')', 'i' );
							scriptEndIndex = html.search( scriptEndRe );
							if ( scriptEndIndex !== -1 ) {
								toIndex = html.indexOf( '>', scriptEndIndex ) + 1;
							} else {
								toIndex = html.indexOf( '>', toIndex ) + 1;
							}
						}

						// append the script
						sb.Append( html.substring( 0, toIndex ) );
						html = html.substring( toIndex );

					} else if ( objectStartRe.test( match ) ) {

						var isValidObject = true;
						var objectHtml = html.substring( 0 ).toLowerCase();
						var objectCount = 1;
						var objectFromIndex = 7;
						var objectStartIndex = 0;
						var objectEndIndex = 0;

						while ( objectCount > 0 ) {
							objectStartIndex = objectHtml.indexOf( '<object', objectFromIndex );
							objectEndIndex = objectHtml.indexOf( '</object>', objectFromIndex );
							if ( objectStartIndex !== -1 && objectStartIndex < objectEndIndex ) {
								objectCount += 1;
								objectFromIndex = objectStartIndex + 7;
							} else {
								if ( objectEndIndex !== -1 ) {
									objectCount -= 1;
									objectFromIndex = objectEndIndex + 9;
								}
							}

							// protected against bad user mark-up
							if ( objectEndIndex === -1 ) {
								isValidObject = false;
								break;
							}
						}

						if ( isValidObject ) {
							sb.Append( createImage( html.substring( 0, objectFromIndex ) ) );
							html = html.substring( objectFromIndex );
						} else {
							sb.Append( html );
							html = '';
						}

					} else if ( embedStartRe.test( match ) ) {

						var embedEndIndex = html.indexOf( '>' );
						if ( html.substr( embedEndIndex - 1, 1 ) === '/' ) {
							embedEndIndex = embedEndIndex + 1;
						} else {
							var embedEndRe = new RegExp( '</embed>', 'i' );
							embedEndIndex = html.search( embedEndRe );
							if ( embedEndIndex !== -1 ) {
								embedEndIndex = embedEndIndex + 8;
							} else {
								embedEndIndex = html.indexOf( '>' ) + 1;
							}
						}

						sb.Append( createImage( html.substring( 0, embedEndIndex ) ) );
						html = html.substring( embedEndIndex );

					} else if ( iFrameStartRe.test( match ) ) {

						var iFrameEndIndex = html.indexOf( '>' );
						var iFrameHtml = html.substring( 0, iFrameEndIndex + 1 );

						var iFrameSrcRe = new RegExp( 'src=(\'|")[^>]*youtube[^\'">]*(\'|")', 'i' );

						iFrameHtml = iFrameHtml.replace( iFrameSrcRe, function( srcHtml ) {

							if ( isWindowModeOpaque ) {
								if ( srcHtml.indexOf( 'wmode' ) === -1 ) {
									if ( srcHtml.indexOf( '?' ) === -1 ) {
										return srcHtml.substring( 0, srcHtml.length - 1 ) + '?wmode=opaque' + srcHtml.substring( srcHtml.length - 1 );
									} else {
										return srcHtml.substring( 0, srcHtml.length - 1 ) + '&amp;wmode=opaque' + srcHtml.substring( srcHtml.length - 1 );
									}
								} else {
									return srcHtml.replace( /wmode=([^&#\'\"]*)/, 'wmode=opaque' );
								}
							} else {
								if ( srcHtml.indexOf( 'wmode' ) !== -1 ) {
									return srcHtml = srcHtml.replace( /wmode=([^&#\'\"]*)/, 'wmode=' );
								} else {
									return srcHtml;
								}
							}

						} );

						sb.Append( iFrameHtml );

						html = html.substring( iFrameEndIndex + 1 );

					}

				} else {
					if ( toIndex === -1 ) {
						sb.Append( html );
						break;
					} else {
						sb.Append( html.substring( 0, toIndex ) );
						html = html.substring( toIndex );
					}
				}

			}

			context.content = sb.ToString();
		}
	}

	function convertToElements(context) {
		if ( context.content && context.content.length > 0 &&
			( context.content.search( /data-isf-content/i ) !== -1 ) ) {

			var html = context.content;
			var sb = new StringBuilder();

			var toIndex = 0;
			var imgStartRe = new RegExp( '(<img)', 'i' );

			while ( html.length > 0 ) {

				imgStartRe.lastIndex = 0;
				toIndex = html.search( imgStartRe );
				if ( toIndex === 0 ) {

					var imgEndIndex = html.indexOf( '>' );
					if ( html.substr( imgEndIndex - 1, 1 ) === '/' ) {
						imgEndIndex = imgEndIndex + 1;
					} else {
						var imgEndRe = new RegExp( '</img>', 'i' );
						imgEndIndex = html.search( imgEndRe );
						if ( imgEndIndex !== -1 ) {
							imgEndIndex = imgEndIndex + 6;
						} else {
							imgEndIndex = html.indexOf( '>' ) + 1;
						}
					}

					var imgHtml = html.substring( 0, imgEndIndex );
					if ( imgHtml.indexOf( 'data-isf-content' ) !== -1 ) {
						sb.Append( createElement(
							getAttributeValue( 'data-isf-content', imgHtml ),
							getAttributeValue( 'height', imgHtml ),
							getAttributeValue( 'width', imgHtml )
						) );
					} else {
						sb.Append( imgHtml );
					}
					html = html.substring( imgEndIndex );

				} else {
					if ( toIndex === -1 ) {
						sb.Append( html );
						break;
					} else {
						sb.Append( html.substring( 0, toIndex ) );
						html = html.substring( toIndex );
					}
				}
			}
			context.content = sb.ToString();
		}
	}

	function command(service, editor) {
		var bookmark = editor.selection.getBookmark();
		service.click().then(function(response) {
			setTimeout(function() {
				document.activeElement.blur();
				editor.focus();
				editor.selection.moveToBookmark(bookmark);
				editor.execCommand('mceInsertContent', false, response);
			}, 10);
		}, function() {
			window.D2LHtmlEditor.PolymerBehaviors.Plugin.clearBookmark(editor, bookmark);
		});
	}

	function init(editor, config) {
		editor.on('BeforeSetContent', function(e) {
			convertToImages(e, config.isWindowModeOpaque);
		});

		editor.on('PostProcess', function(e) {
			if (e.get) {
				convertToElements(e);
			}
		});
	}

	/** @polymerBehavior */
	var InsertStuffBehavior = {
		plugin: {
			id: 'd2l_isf',
			label: 'Insert Stuff',
			icon: 'd2l_isf',
			serviceId: 'fra-html-editor-isf',
			cmd: command,
			init: init
		}
	};

	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.InsertStuff = InsertStuffBehavior;

})();
</script>
<dom-module id="d2l-insertstuff-styles" assetpath="/">
  <template>
    <style>
		.disf_default, .disf_flash, .disf_shockwave, .disf_quicktime, .disf_windowsmedia, .disf_realmedia {
      border-radius: 0.3rem;
      background-color: #f9fafb;
      border: 1px solid #d3d9e3;
			background-position:center;
			background-repeat:no-repeat;
      background-image: url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2230%22%20height%3D%2230%22%20viewBox%3D%220%200%2030%2030%22%3E%3Cg%20fill%3D%22none%22%3E%3Cg%20fill%3D%22%2372777A%22%3E%3Cpath%20d%3D%22M22%202C23.1%202%2024%202.9%2024%204L24%2022C24%2023.1%2023.1%2024%2022%2024L4%2024C2.9%2024%202%2023.1%202%2022L2%204C2%202.9%202.9%202%204%202L22%202%2022%202ZM22%200L4%200C1.8%200%200%201.8%200%204L0%2022C0%2024.2%201.8%2026%204%2026L22%2026C24.2%2026%2026%2024.2%2026%2022L26%204C26%201.8%2024.2%200%2022%200L22%200%2022%200Z%22%2F%3E%3Cpath%20d%3D%22M10%2021C9.4%2021%209%2020.6%209%2020L9%206C9%205.6%209.2%205.3%209.6%205.1%209.9%204.9%2010.3%205%2010.6%205.2L19.6%2012.2C19.9%2012.4%2020%2012.7%2020%2013%2020%2013.3%2019.9%2013.6%2019.6%2013.8L10.6%2020.8C10.4%2020.9%2010.2%2021%2010%2021L10%2021ZM11%208L11%2018%2017.4%2013%2011%208Z%22%2F%3E%3Cpath%20d%3D%22M30%208L30%2026C30%2028.2%2028.2%2030%2026%2030L8%2030C7.4%2030%207%2029.6%207%2029%207%2028.4%207.4%2028%208%2028L24%2028C26.2%2028%2028%2026.2%2028%2024L28%208C28%207.4%2028.4%207%2029%207%2029.6%207%2030%207.4%2030%208L30%208Z%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E");
		}

		.disf_default:hover, .disf_flash:hover, .disf_shockwave:hover, .disf_quicktime:hover, .disf_windowsmedia:hover, .disf_realmedia:hover {
      background-color: #f9f8fc;
      border: 1px solid #006fbf;
      background-image: url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2230%22%20height%3D%2230%22%20viewBox%3D%220%200%2030%2030%22%3E%3Cg%20fill%3D%22none%22%3E%3Cg%20fill%3D%22%231C5295%22%3E%3Cpath%20d%3D%22M22%202C23.1%202%2024%202.9%2024%204L24%2022C24%2023.1%2023.1%2024%2022%2024L4%2024C2.9%2024%202%2023.1%202%2022L2%204C2%202.9%202.9%202%204%202L22%202%2022%202ZM22%200L4%200C1.8%200%200%201.8%200%204L0%2022C0%2024.2%201.8%2026%204%2026L22%2026C24.2%2026%2026%2024.2%2026%2022L26%204C26%201.8%2024.2%200%2022%200L22%200%2022%200Z%22%2F%3E%3Cpath%20d%3D%22M10%2021C9.4%2021%209%2020.6%209%2020L9%206C9%205.6%209.2%205.3%209.6%205.1%209.9%204.9%2010.3%205%2010.6%205.2L19.6%2012.2C19.9%2012.4%2020%2012.7%2020%2013%2020%2013.3%2019.9%2013.6%2019.6%2013.8L10.6%2020.8C10.4%2020.9%2010.2%2021%2010%2021L10%2021ZM11%208L11%2018%2017.4%2013%2011%208Z%22%2F%3E%3Cpath%20d%3D%22M30%208L30%2026C30%2028.2%2028.2%2030%2026%2030L8%2030C7.4%2030%207%2029.6%207%2029%207%2028.4%207.4%2028%208%2028L24%2028C26.2%2028%2028%2026.2%2028%2024L28%208C28%207.4%2028.4%207%2029%207%2029.6%207%2030%207.4%2030%208L30%208Z%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E");
		}
    </style>
  </template>
</dom-module>
<script>
(function() {
	'use strict';

	function command(service, editor) {
		var bookmark = editor.selection.getBookmark();
		service.click().then(function(response) {
			// setTimeout 10 required for IE to get focus back
			// document.activeELement.blur() required for Chrome to get focus back
			// moveToBookmark required by IE
			setTimeout(function() {
				document.activeElement.blur();
				editor.focus();
				editor.selection.moveToBookmark(bookmark);
				editor.execCommand('mceInsertContent', false, response);
			}, 10);
		}, function() {
			window.D2LHtmlEditor.PolymerBehaviors.Plugin.clearBookmark(editor, bookmark);
		});
	}

	/** @polymerBehavior */
	var ImageBehavior = {
		plugin: {
			id: 'd2l_image',
			label: 'Add Image',
			icon: 'd2l_image',
			serviceId: 'fra-html-editor-image',
			cmd: command,
			init: function() {}
		}
	};

	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.Image = ImageBehavior;

})();
</script>
<script>
(function() {
	'use strict';
	/*global tinymce:true */
	/** @polymerBehavior */
	var TextStyleRollupBehavior = {
		plugin: {
			id: 'd2l_textstylerollup',
			initPlugin: function() {
				tinymce.PluginManager.add('d2l_textstylerollup', function(editor) {
					editor.addButton('d2l_textstylerollup', {
						type   : 'MenuButton',
						icon   : 'arrowdown',
						title  : 'Text Styles',
						menu   : [
							editor.menuItems.strikethrough,
							editor.menuItems.subscript,
							editor.menuItems.superscript]
					});
				});
			}
		}
	};

	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.TextStyleRollup = TextStyleRollupBehavior;

})();
</script>
<script>
(function() {
	'use strict';
	/*global tinymce:true */
	/** @polymerBehavior */
	var FormatRollupBehavior = {
		plugin: {
			id: 'd2l_formatrollup',
			initPlugin: function() {
				tinymce.PluginManager.add('d2l_formatrollup', function(editor) {
					editor.addMenuItem('custom_numlist', {
						text: 'Ordered List',
						context: 'format',
						icon: 'numlist',
						cmd: 'InsertOrderedList'
					});
					editor.addMenuItem('custom_indent', {
						text: 'Indent',
						context: 'format',
						icon: 'indent',
						cmd: 'Indent'
					});
					editor.addMenuItem('custom_outdent', {
						text: 'Outdent',
						context: 'format',
						icon: 'outdent',
						cmd: 'Outdent'
					});
					editor.addMenuItem('custom_alignleft', {
						text: 'Align Left',
						context: 'format',
						icon: 'alignleft',
						cmd: 'JustifyLeft'
					});
					editor.addMenuItem('custom_alignright', {
						text: 'Align Right',
						context: 'format',
						icon: 'alignright',
						cmd: 'JustifyRight'
					});
					editor.addMenuItem('custom_aligncenter', {
						text: 'Align Center',
						context: 'format',
						icon: 'aligncenter',
						cmd: 'JustifyCenter'
					});
					editor.addMenuItem('custom_alignjustify', {
						text: 'Align Full',
						context: 'format',
						icon: 'alignjustify',
						cmd: 'JustifyFull'
					});
					editor.addMenuItem('custom_ltr', {
						text: 'Left to Right',
						context: 'format',
						icon: 'ltr',
						cmd: 'mceDirectionLTR'
					});
					editor.addMenuItem('custom_rtl', {
						text: 'Right to Left',
						context: 'format',
						icon: 'rtl',
						cmd: 'mceDirectionRTL'
					});

					editor.addButton('d2l_formatrollup', {
						type: 'MenuButton',
						icon   : 'arrowdown',
						title  : 'Format',
						menu   : [editor.menuItems.custom_numlist,
									editor.menuItems.custom_indent,
									editor.menuItems.custom_outdent,
									editor.menuItems.custom_alignleft,
									editor.menuItems.custom_alignright,
									editor.menuItems.custom_aligncenter,
									editor.menuItems.custom_alignjustify,
									editor.menuItems.custom_ltr,
									editor.menuItems.custom_rtl]
					});
				});
			}
		}
	};
	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.FormatRollup = FormatRollupBehavior;

})();
</script>
<script>
(function() {
	'use strict';
	/*global tinymce:true */
	/** @polymerBehavior */
	var InsertRollupBehavior = {
		plugin: {
			id: 'd2l_insertrollup',
			initPlugin: function() {
				tinymce.PluginManager.add('d2l_insertrollup', function(editor) {
					editor.addButton('d2l_insertrollup', {
						type   : 'MenuButton',
						icon   : 'arrowdown',
						title  : 'Insert',
						menu   : [editor.menuItems.charmap, editor.menuItems.hr]
					});
				});
			}
		}
	};

	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.InsertRollup = InsertRollupBehavior;

})();
</script>
<script>
(function() {
	'use strict';

	function getQuickLinkSelectedText(editor) {

		var text;

		var selectedNode = window.D2LHtmlEditor.PolymerBehaviors.Plugin.getSelectedNode(editor);
		if (selectedNode && selectedNode.nodeName === 'A') {
			text = Polymer.dom(selectedNode).textContent;
		} else {
			text = window.D2LHtmlEditor.PolymerBehaviors.Plugin.getSelectionContent(editor);
		}

		if (text === undefined || text === null) {
			text = '';
		}

		return text;
	}

	function getQuickLinkData(editor) {

		var node = window.D2LHtmlEditor.PolymerBehaviors.Plugin.getSelectedNode(editor);

		if ( node === null || node.nodeName !== 'A' ) {
			return null;
		}

		var href = node.getAttribute( 'href' );

		var title = Polymer.dom(node).textContent;

		var target = node.getAttribute('target');
		if (target === '_top') {
			target = 'WholeWindow';
		} else if (target === '_blank') {
			target = 'NewWindow';
		} else {
			target = 'SameFrame';
		}

		var properties = [];
		properties.push({
			name: 'target',
			value: target
		});

		return {
			href: href,
			title: title,
			properties: properties,
			outputFormat: 'html'
		};
	}

	function getQuickLink(editor) {
		return {
			selectedText: getQuickLinkSelectedText(editor),
			itemData: getQuickLinkData(editor)
		};
	}

	function command(service, editor) {
		var quickLinkData = getQuickLink(editor);
		var bookmark = editor.selection.getBookmark();
		service.click(quickLinkData).then(function(response) {
			// setTimeout 10 required for IE to get focus back
			// document.activeELement.blur() required for Chrome to get focus back
			// moveToBookmark required by IE
			setTimeout(function() {
				document.activeElement.blur();
				editor.focus();
				editor.selection.moveToBookmark(bookmark);
				var selectedNode = window.D2LHtmlEditor.PolymerBehaviors.Plugin.getSelectedNode(editor);
				if (selectedNode !== null && selectedNode.nodeName === 'A' ) {
					// replace current link (i.e. if caret is inside of anchor)
					editor.selection.select(selectedNode);
				}
				editor.execCommand('mceInsertContent', false, response);
			}, 10);
		}, function() {
			window.D2LHtmlEditor.PolymerBehaviors.Plugin.clearBookmark(editor, bookmark);
		});
	}

	/** @polymerBehavior */
	var LinkBehavior = {
		plugin: {
			id: 'd2l_link',
			label: 'Add Link',
			icon: 'd2l_link',
			serviceId: 'fra-html-editor-link',
			cmd: command,
			init: function() {}
		}
	};

	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.Link = LinkBehavior;

})();
</script>
<script>
(function() {
	'use strict';
	/*global tinymce:true */
	/** @polymerBehavior */
	var CodeBehavior = {
		plugin: {
			id: 'd2l_code',
			initPlugin: function(client) {
				tinymce.PluginManager.add('d2l_code', function(editor) {

					function showDialog() {
						var win = editor.windowManager.open({
							title: 'Source code',
							body: {
								type: 'textbox',
								name: 'code',
								multiline: true,
								minWidth: editor.getParam('code_dialog_width', 600),
								minHeight: editor.getParam('code_dialog_height', Math.min(tinymce.DOM.getViewPort().h - 200, 500)),
								spellcheck: false,
								style: 'direction: ltr; text-align: left'
							},
							onSubmit: function(e) {
								// We get a lovely "Wrong document" error in IE 11 if we
								// don't move the focus to the editor before creating an undo
								// transation since it tries to make a bookmark for the current selection
								client.getService('convert-to-viewable-html', '0.1').then(function(service) {
									return service.filterHtml(e.data.code);
								}).then(function(response) {
									editor.focus();

									editor.undoManager.transact(function() {
										editor.setContent(response);
									});

									editor.selection.setCursorLocation();
									editor.nodeChanged();
								});
							}
						});

						// Gecko has a major performance issue with textarea
						// contents so we need to set it when all reflows are done
						win.find('#code').value(editor.getContent({source_view: true}));
					}

					editor.addButton('d2l_code', {
						icon: 'code',
						tooltip: 'Source code',
						onclick: showDialog
					});

				});
			}
		}
	};
	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.Code = CodeBehavior;

})();
</script>
<script>
/*

Code based on the LMS file:
/LSOne/lp/framework/web/D2L.LP.Web.UI/Desktop/Controls/HtmlEditor/Components/Scripts/ReplaceString/ReplaceString.js commit version b6e80554112
https://git.dev.d2l/projects/CORE/repos/lp/commits/b6e80554112a8034f548df7f4539e6b3840aecfd
Check that file periodically for changes.

*/
(function() {
	'use strict';
	function encodeReplaceStrings( context, replacementToken, replacementValue ) {
		var obj = context;
		var html = obj.content;

		if (html !== null && html.length > 0) {

			var func = function(match) {
				var tempNode = document.createElement('div');

				// setting the innerHTML automatically closes any opening tags. The regex
				// only matches the opening tag, so this will cause a duplicate closing tag
				// when we replace later.
				tempNode.innerHTML = match;
				var img = tempNode.firstChild;
				var src = img.getAttribute('data-mce-src'); //plugin.Attributes.Data);

				if (!src) {
					src = img.getAttribute('src');
				}
				var originalSrc = src;

				// loop through possible replace strings and replace them
				var key = replacementToken;
				var regEx = new RegExp('{' + key + '}', 'i');
				src = src.replace(regEx, replacementValue);

				if (src !== originalSrc) {
					img.setAttribute('src', src);
					img.setAttribute('data-d2l-src', encodeURIComponent(originalSrc));

					var temp = tempNode.innerHTML;
					temp = temp.replace( /<\/iframe>/gi, '' );

					return temp;
				} else {
					// no change
					return match;
				}
			};

			// find all occurrences of <img src="something" /> and call func
			html = html.replace(/<(img|iframe)[^>]*\ssrc[\s]*=[\s]*(\'([^\']*)\'|\"([^\"]*)\"|([^>^\s^\/]*))[^>]*>/gi, func);
			obj.content = html;
		}
	}

	function decodeReplaceStrings(obj) {
		var html = obj.content;

		if (html !== null && html.length > 0) {

			var func = function(match) {
				var tempNode = document.createElement('div');

				// setting the innerHTML automatically closes any opening tags. The regex
				// only matches the opening tag, so this will cause a duplicate closing tag
				// when we replace later.
				tempNode.innerHTML = match;

				var img = tempNode.firstChild;
				var d2l_src = img.getAttribute('data-d2l-src');

				if (d2l_src !== '') {

					img.setAttribute('src', decodeURIComponent(d2l_src));
					img.removeAttribute('data-d2l-src');

					var temp = tempNode.innerHTML;
					temp = temp.replace( /<\/iframe>/gi, '' );

					return temp;
				} else {
					return match;
				}
			};

			// find all occurrences of <img data-d2l-src="something" /> and call func
			html = html.replace(/<(img|iframe)[^>]*\sdata-d2l-src[\s]*=[\s]*(\'([^\']*)\'|\"([^\"]*)\"|([^>^\s^\/]*))[^>]*>/gi, func);
			// convert %7Bstuff%7D to {stuff} -> Mozilla based browsers
			obj.content = html.replace(/(%7B(orgId|orgName|orgUnitId|OrgUnitName|OrgUnitCode|OrgUnitPath|UserId|UserName|OrgDefinedId|FirstName|LastName|ExternalEmail|InternalEmail|RoleId)%7D)/gi, '{$2}');
		}
	}

	/*global tinymce:true */
	/** @polymerBehavior */
	var ReplaceStringBehavior = {
		plugin: {
			id: 'd2l_replacestring',
			initPlugin: function(client) {
				client.request('orgUnit').then(function(orgUnit) {
					tinymce.PluginManager.add('d2l_replacestring', function(editor) {
						editor.on('BeforeSetContent', function(e) {
							encodeReplaceStrings(e, 'orgUnitId', orgUnit.OrgUnitId);
						});

						editor.on('PostProcess', function(e) {
							if (e.get) {
								decodeReplaceStrings(e);
							}
						});
					});
				});

			}
		}
	};
	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.ReplaceString = ReplaceStringBehavior;

})();
</script>
</div><dom-module id="d2l-html-editor">

	<template>

		<style include="d2l-insertstuff-styles"></style>

		<style>
			:host {
				display: block;
				position: relative;
			}

			.toolbar {
				position: absolute;
				top: -2.9rem;
				z-index: 1001;
				display: inline-block;
				right: 0rem;
			}
			/*
			:host[dir="ltr"] .toolbar {
				right: -1rem;
			}
			*/

			:host-context([dir='rtl']) .toolbar {
				left: 0rem;
				right: inherit;
			}

			:host ::content div > p:first-of-type {
				margin-top: 0
			}

			:host ::content div > p:last-of-type {
				margin-bottom: 0;
			}

		</style>

		<div id$="[[toolbarId]]" class="toolbar"></div>
		<content></content>

	</template>

</dom-module>
<script>
	Polymer({

		is: 'd2l-html-editor',

		behaviors: [
			window.D2LHtmlEditor.PolymerBehaviors.InsertStuff,
			window.D2LHtmlEditor.PolymerBehaviors.Image,
			window.D2LHtmlEditor.PolymerBehaviors.Link,
			window.D2LHtmlEditor.PolymerBehaviors.TextStyleRollup,
			window.D2LHtmlEditor.PolymerBehaviors.FormatRollup,
			window.D2LHtmlEditor.PolymerBehaviors.InsertRollup,
			window.D2LHtmlEditor.PolymerBehaviors.Code,
			window.D2LHtmlEditor.PolymerBehaviors.ReplaceString
		],

		/**
		 * @see tinymce config
		 */
		properties: {
			inline: {
				type: Number,
				value: 1
			},
			autoFocus: {
				type: Number,
				value: 0
			},
			minRows: {
				type: Number,
				value: 1
			},
			maxRows: {
				type: Number,
				value: 3
			},
			totalPadding: {
				type: Number,
				value: 0.9
			},
			lineHeight: {
				type: Number,
				value: 1.2
			},
			minHeight: {
				type: String,
				computed: 'computeHeight(totalPadding, minRows, lineHeight)'
			},
			maxHeight: {
				type: String,
				computed: 'computeHeight(totalPadding, maxRows, lineHeight)'
			},
			editorId: String,
			toolbarId: {
				type: String,
				computed: 'computeToolbarId(editorId)'
			},
			content: String,
			baseUrl: {
				type: String,
				value: null
			},
			documentBaseUrl: {
				type: String,
				value: null
			},
			cssUrl: {
				type: String,
				value: null
			},
			appRoot: {
				type: String,
				vale: null
			}
		},

		/**
		 * Textarea where tinymce is instantiate
		 * @return {HTMLElement}
		 */
		element: null,

		// Element Lifecycle
		registered: function() {
			var client = window.ifrauclient({
				syncFont: false,
				syncLang: false,
				resizeFrame: false
			});
			this.editorReady = client.connect().then(function() {
				return this._configureTinyMce(client);
			}.bind(this));
		},

		ready: function() {
			// `ready` is called after all elements have been configured, but
			// propagates bottom-up. This element's children are ready, but parents
			// are not.
			//
			// This is the point where you should make modifications to the DOM (when
			// necessary), or kick off any processes the element wants to perform.
		},

		attached: function() {
			// `attached` fires once the element and its parents have been inserted
			// into a document.
			//
			// This is a good place to perform any work related to your element's
			// visual state or active behavior (measuring sizes, beginning animations,
			// loading resources, etc).

			this.initialize();
			this.fire('d2l-html-editor-attached');
		},

		detached: function() {
			// The analog to `attached`, `detached` fires when the element has been
			// removed from a document.
			//
			// Use this to clean up anything you did in `attached`.
			this.cleanup();
		},

		_addPlugin: function(client, plugin) {
			var d2lEditor = this;
			if (plugin.initPlugin) {
				plugin.initPlugin(client);
				return;
			}
			return client.getService(plugin.serviceId, '0.1').then(function(service) {
				return service.config();
			}).then(function(config) {
				if (!config.isEnabled) {
					// Add empty plugin so that we don't have to conditionally set the plugin list - maybe fix later
					tinymce.PluginManager.add(plugin.id, function() {   // eslint-disable-line no-undef
					});
				} else {
					tinymce.PluginManager.add(plugin.id, function(editor) {   // eslint-disable-line no-undef
						editor.addButton(plugin.id, {
							tooltip: plugin.label,
							icon: plugin.icon,
							onclick: function() {
								d2lEditor._callService(client, plugin.serviceId, editor, plugin.cmd);
							}
						});

						plugin.init(editor, config);
					});
				}
			}).catch(function() {
			});
		},

		_configurePlugins: function(client) {
			var pluginDefinitions = this.behaviors.map(function(behavior) {
				return behavior.plugin;
			});

			var plugins = [];
			pluginDefinitions.forEach(function(plugin) {
				if (plugin) {
					plugins.push(this._addPlugin(client, plugin));
				}
			}, this);
			return plugins;
		},

		_configureTinyMce: function(client) {
			var plugins = this._configurePlugins(client);
			return Promise.all(plugins);  // eslint-disable-line no-undef
		},

		_callService: function(client, serviceId, editor, fn) {
			client.getService(serviceId, '0.1').then(function(service) {
				fn.call(null, service, editor);
			});
		},

		initialize: function() {
			this.editorReady.then(function() {
				this._init();
			}.bind(this));
		},

		// We cannot cleanup in detached because React seems to cause the web component
		// to detach/attach during move operations
		cleanup: function() {
			tinymce.EditorManager.execCommand('mceRemoveEditor', true, this.editorId); // eslint-disable-line no-undef
			this.client = null;
		},

		focus: function() {
			tinymce.EditorManager.get(this.editorId).focus(); // eslint-disable-line no-undef
		},

		getContent: function() {
			return tinymce.EditorManager.get(this.editorId).getContent(); // eslint-disable-line no-undef
		},

		_init: function() {
			if (null !== this.baseUrl) {
				tinyMCE.baseURL = this.baseUrl; // eslint-disable-line
			}

			// In React 15 Polymer dom APIs for distributed light DOM children
			// seem to be broken - this will probably not work in Shadow DOM
			// this.element = Polymer.dom(this).querySelector('#' + this.editorId);
			this.element = this.querySelector('#' + this.editorId);
			this.element.style.overflowY = 'auto';
			this.element.style.minHeight = this.minHeight;
			this.element.style.maxHeight = this.maxHeight;

			this._initTinyMCE();
		},

		/**
		 * Init tinyMCE
		 * @private
		 */
		_initTinyMCE: function() {
			var that = this;
			var config = {
				selector: '#' + this.editorId,
				plugins: 'd2l_image d2l_isf d2l_link autolink table fullscreen directionality hr textcolor colorpicker d2l_code d2l_replacestring charmap link lists d2l_formatrollup d2l_textstylerollup d2l_insertrollup',
				toolbar: this.inline ? 'bold italic underline d2l_image d2l_isf equation fullscreen' : 'bold italic underline d2l_textstylerollup | d2l_image d2l_isf d2l_link d2l_insertrollup | equation | bullist d2l_formatrollup | table | forecolor | styleselect | fontselect fontsizeselect | undo redo | d2l_code | smallscreen',
				fontsize_formats: '8pt 10pt 12pt 14pt 18pt 24pt 36pt',
				style_formats: [
								{title: 'Paragraph', format: 'p'},
								{title: 'Address', format: 'address'},
								{title: 'Preformatted', format: 'pre'},
								{title: 'Header 1', format: 'h1'},
                                {title: 'Header 2', format: 'h2'},
                                {title: 'Header 3', format: 'h3'},
                                {title: 'Header 4', format: 'h4'},
                                {title: 'Header 5', format: 'h5'},
                                {title: 'Header 6', format: 'h6'}
				],
				auto_focus: this.autoFocus ? this.editorId : null,
				menubar: false,
				statusbar: false,
				fixed_toolbar_container: '#' + this.toolbarId,
				inline: this.inline ? true : false,
				document_base_url: this.documentBaseUrl + '/',
				content_css: this.cssUrl + ',' + this.appRoot + '../d2l-html-editor/d2l-insertstuff.css',
				skin_url: this.appRoot + '../d2l-html-editor/skin-4.3.7',
				convert_urls: false,
				relative_urls: false,
				setup: function(editor) {
					var equationSetting = 1;
					var equationButton;
					editor.on('init', function() {
						if (that.content) {
							editor.setContent(decodeURIComponent(that.content));
							// After initial initialization, clear content. The web component may become
							// detached due to React reordering.  This will cause a re-init, but we want
							// it to re-init from the current content.  We will look at preventing
							// initialization on attach/detach in future.  However, detach is currently
							// the simplest place to clean up the TinyMCE editor.  Probably should include
							// a property to auto clean up, otherwise would need to explicitly call a clean
							// up method from React componentWillUnmount.
							that.content = null;
						}
					});

					editor.on('change', function() {
						that.fire('change', {content: editor.getContent()});
					});

					editor.on('focusin', function(e) {
						that.fire('focus', e);
					});

					editor.on('focusout', function(e) {
						that.fire('blur', e);
					});

					editor.on('keyup', function() {
						// that.element.value = editor.getContent();
					});

					editor.addMenuItem('graphical_editor', {
						icon: 'd2l_graphical_equation',
						text: 'Graphical equation',
						onclick: function() {
							if (equationSetting !== 1) {
								equationSetting = 1;
								equationButton.icon('d2l_graphical_equation');
								equationButton.aria('label', 'Graphical Equation Selected - Equation Editor');
							}
						}
					});

					editor.addMenuItem('mml_editor', {
						icon: 'd2l_mml',
						text: 'MathML equation',
						onclick: function() {
							if (equationSetting !== 2) {
								equationSetting = 2;
								equationButton.icon('d2l_mml');
								equationButton.aria('label', 'MathML Equation Selected - Equation Editor');
							}
						}
					});

					editor.addMenuItem('latex_editor', {
						icon: 'd2l_latex',
						text: 'LaTex equation',
						onclick: function() {
							if (equationSetting !== 3) {
								equationSetting = 3;
								equationButton.icon('d2l_latex');
								equationButton.aria('label', 'Latex Equation Selected - Equation Editor');
							}
						}
					});

					editor.addButton('equation', {
						title: 'Graphical Equation Selected - Equation Editor',
						icon: 'd2l_graphical_equation',
						type: 'splitbutton',
						menu: [editor.menuItems['graphical_editor'],
						editor.menuItems['mml_editor'],
						editor.menuItems['latex_editor']],
						onPostRender: function() {
							equationButton = this;
						},
						onclick: function() {
						}
					});

					editor.addButton('fullscreen', {
						title: 'Open in Full Screen Editor',
						icon: 'd2l_fullscreen',
						onclick: function() {
							that.fire('fullscreen');
						}
					});

					editor.addButton('smallscreen', {
						title: 'Close Full Screen Editor',
						icon: 'd2l_smallscreen',
						onclick: function() {
							editor.execCommand('mceFullScreen');
							that.fire('restore');
						}
					});

					if (!this.inline) {
						editor.on('init', function() {
							editor.execCommand('mceFullScreen');
							editor.getBody().setAttribute('aria-label', 'Press ALT-F10 for toolbar, and press ESC to exit toolbar once inside');
						});
					}
				}
			};

			tinymce.init(config); // eslint-disable-line no-undef

			// need to reset auto focus property to prevent unwanted focus during re-ordering of the options
			this.autoFocus = 0;
		},

		computeToolbarId: function(editorId) {
			return editorId + '-toolbar';
		},

		computeHeight: function(totalPadding, rows, lineHeight) {
			return totalPadding + (lineHeight * rows) + 'rem';
		}
	});

</script>
</body></html>
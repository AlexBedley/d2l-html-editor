<script>
(function() {
	'use strict';

	function getSelectedNode(editor) {
		var node = null;
		if (editor && editor.selection) {
			node = editor.selection.getNode();
		}

		return node;
	}

	function getSelectionContent(editor) {
		var content = '';
		if (editor && editor.selection) {
			content = tinymce.DOM.decode(editor.selection.getContent());  // eslint-disable-line no-undef
		}
		return content;
	}

	function getQuickLinkSelectedText(editor) {

		var text;

		var selectedNode = getSelectedNode(editor);
		if (selectedNode && selectedNode.nodeName === 'A') {
			text = Polymer.dom(selectedNode).textContent;
		} else {
			text = getSelectionContent(editor);
		}

		if (text === undefined || text === null) {
			text = '';
		}

		return text;
	}

	function getQuickLinkData(editor) {

		var node = getSelectedNode(editor);

		if ( node === null || node.nodeName !== 'A' ) {
			return null;
		}

		var href = node.getAttribute( 'href' );

		var title = Polymer.dom(node).textContent;

		var target = node.getAttribute('target');
		if (target == '_top') {
			target = 'WholeWindow';
		} else if (target == '_blank') {
			target = 'NewWindow';
		} else {
			target = 'SameFrame';
		}

		var properties = [];
		properties.push({
			name: 'target',
			value: target
		});

		return {
			href: href,
			title: title,
			properties: properties,
			outputFormat: 'html'
		};
	}

	function getQuickLink(editor) {
		return {
			selectedText: getQuickLinkSelectedText(editor),
			itemData: getQuickLinkData(editor)
		};
	}

	function command(service, editor) {
		var quickLinkData = getQuickLink(editor);
		var bookmark = editor.selection.getBookmark();
		service.click(quickLinkData).then(function(response) {
			// setTimeout 10 required for IE to get focus back
			// document.activeELement.blur() required for Chrome to get focus back
			// moveToBookmark required by IE
			setTimeout(function() {
				document.activeElement.blur();
				editor.focus();
				editor.selection.moveToBookmark(bookmark);
				editor.execCommand('mceInsertContent', false, response);
			}, 10);
		}, function() {
			var selectedNode = getSelectedNode(editor);
			var parentNode = Polymer.dom(selectedNode).parentNode;
			var nodeStart = Polymer.dom(parentNode).querySelector('#' + bookmark.id + '_start');
			if (nodeStart) {
				var nodeStartParent = Polymer.dom(nodeStart).parentNode;
				Polymer.dom(nodeStartParent).removeChild(nodeStart);
			}
			var nodeEnd = Polymer.dom(parentNode).querySelector('#' + bookmark.id + '_end');
			if (nodeEnd) {
				var nodeEndParent = Polymer.dom(nodeEnd).parentNode;
				Polymer.dom(nodeEndParent).removeChild(nodeEnd);
			}

		});
	}

	/** @polymerBehavior */
	var LinkBehavior = {
		plugin: {
			id: 'd2l_link',
			label: 'Add Link',
			icon: 'd2l_link',
			serviceId: 'fra-html-editor-link',
			cmd: command,
			init: function() {}
		}
	};

	window.D2LHtmlEditor = window.D2LHtmlEditor || {};
	window.D2LHtmlEditor.PolymerBehaviors = window.D2LHtmlEditor.PolymerBehaviors || {};
	/** @polymerBehavior */
	window.D2LHtmlEditor.PolymerBehaviors.Link = LinkBehavior;

})();
</script>

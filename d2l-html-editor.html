<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="ifrau-client-import.html">
<link rel="import" href="tinymce-import.html">
<link rel="import" href="d2l-insertstuff-plugin.html">
<link rel="import" href="d2l-insertstuff-styles.html">
<link rel="import" href="d2l-image-plugin.html">
<link rel="import" href="d2l-textstylerollup-plugin.html">
<link rel="import" href="d2l-formatrollup-plugin.html">
<link rel="import" href="d2l-insertrollup-plugin.html">
<link rel="import" href="d2l-link-plugin.html">

<!-- this does not seem to work if it is inside the polymer component below -->
<style>
			.mce-i-bold:before {
				content: url('../d2l-icons/images/html-editor/bold.svg') !important;
			}
			.mce-i-italic:before {
				content: url('../d2l-icons/images/html-editor/italic.svg') !important;
			}
			.mce-i-underline:before {
				content: url('../d2l-icons/images/html-editor/underline.svg') !important;
			}
			.mce-i-arrowdown:before {
				content: url('../d2l-icons/images/tier1/chevron-down.svg') !important;
			}
			.mce-i-strikethrough:before {
				content: url('../d2l-icons/images/html-editor/strikethrough.svg') !important;
			}
			.mce-i-superscript:before {
				content: url('../d2l-icons/images/html-editor/superscript.svg') !important;
			}
			.mce-i-subscript:before {
				content: url('../d2l-icons/images/html-editor/subscript.svg') !important;
			}
			.mce-i-charmap:before {
				content: url('../d2l-icons/images/html-editor/symbol.svg') !important;
			}
			.mce-i-bullist:before {
				content: url('../d2l-icons/images/html-editor/list-bullet.svg') !important;
			}
			.mce-i-numlist:before {
				content: url('../d2l-icons/images/html-editor/list-ordered.svg') !important;
			}
			.mce-i-indent:before {
				content: url('../d2l-icons/images/html-editor/indent-increase.svg') !important;
			}
			.mce-i-outdent:before {
				content: url('../d2l-icons/images/html-editor/indent-decrease.svg') !important;
			}
			.mce-i-alignleft:before {
				content: url('../d2l-icons/images/html-editor/align-left.svg') !important;
			}
			.mce-i-alignright:before {
				content: url('../d2l-icons/images/html-editor/align-right.svg') !important;
			}
			.mce-i-aligncenter:before {
				content: url('../d2l-icons/images/html-editor/align-center.svg') !important;
			}
			.mce-i-alignjustify:before {
				content: url('../d2l-icons/images/html-editor/align-full.svg') !important;
			}
			.mce-i-ltr:before {
				content: url('../d2l-icons/images/html-editor/direction-ltr.svg') !important;
			}
			.mce-i-rtl:before {
				content: url('../d2l-icons/images/html-editor/direction-rtl.svg') !important;
			}
			.mce-i-undo:before {
				content: url('../d2l-icons/images/tier1/undo.svg') !important;
			}
			.mce-i-redo:before {
				content: url('../d2l-icons/images/tier1/redo.svg') !important;
			}
			.mce-i-cut:before {
				content: url('../d2l-icons/images/html-editor/cut.svg') !important;
			}
			.mce-i-paste:before {
				content: url('../d2l-icons/images/html-editor/paste.svg') !important;
			}
			.mce-i-code:before {
				content: url('../d2l-icons/images/html-editor/source-editor.svg') !important;
			}
			.mce-i-d2l_graphical_equation:before {
				content: url('../d2l-icons/images/html-editor/equation-graphical.svg') !important;
			}
			.mce-i-d2l_mml:before {
				content: url('../d2l-icons/images/html-editor/equation-mathml.svg') !important;
			}
			.mce-i-d2l_latex:before {
				content: url('../d2l-icons/images/html-editor/equation-latex.svg') !important;
			}

</style>

<!--<link rel="import" href="./vui-input-styles.html">-->

<!--
An element providing a solution to no problem in particular.

Example:

		<d2l-html-editor></d2l-html-editor>

@demo
-->
<dom-module id="d2l-html-editor">

	<template>

		<style include="d2l-insertstuff-styles"></style>

		<style>
			:host {
				display: block;
				position: relative;
			}

			.toolbar {
				position: absolute;
				top: -3.2rem;
				z-index: 1001;
				display: inline-block;
				right: 0rem;
			}
			/*
			:host[dir="ltr"] .toolbar {
				right: -1rem;
			}
			*/

			:host-context([dir='rtl']) .toolbar {
				left: 0rem;
				right: inherit;
			}

			:host ::content div > p:first-of-type {
				margin-top: 0
			}

			:host ::content div > p:last-of-type {
				margin-bottom: 0;
			}

		</style>

		<div id$="[[toolbarId]]" class="toolbar"></div>
		<content></content>

	</template>

</dom-module>
<script>
	Polymer({

		is: 'd2l-html-editor',

		behaviors: [
			window.D2LHtmlEditor.PolymerBehaviors.InsertStuff,
			window.D2LHtmlEditor.PolymerBehaviors.Image,
			window.D2LHtmlEditor.PolymerBehaviors.Link,
			window.D2LHtmlEditor.PolymerBehaviors.TextStyleRollup,
			window.D2LHtmlEditor.PolymerBehaviors.FormatRollup,
			window.D2LHtmlEditor.PolymerBehaviors.InsertRollup
		],

		/**
		 * @see tinymce config
		 */
		properties: {
			inline: {
				type: Number,
				value: 1
			},
			autoFocus: {
				type: Number,
				value: 0
			},
			minRows: {
				type: Number,
				value: 1
			},
			maxRows: {
				type: Number,
				value: 3
			},
			totalPadding: {
				type: Number,
				value: 0.9
			},
			lineHeight: {
				type: Number,
				value: 1.2
			},
			minHeight: {
				type: String,
				computed: 'computeHeight(totalPadding, minRows, lineHeight)'
			},
			maxHeight: {
				type: String,
				computed: 'computeHeight(totalPadding, maxRows, lineHeight)'
			},
			editorId: String,
			toolbarId: {
				type: String,
				computed: 'computeToolbarId(editorId)'
			},
			content: String,
			baseUrl: {
				type: String,
				value: null
			},
			documentBaseUrl: {
				type: String,
				value: null
			},
			cssUrl: {
				type: String,
				value: null
			},
			appRoot: {
				type: String,
				vale: null
			}
		},

		/**
		 * Textarea where tinymce is instantiate
		 * @return {HTMLElement}
		 */
		element: null,

		// Element Lifecycle
		registered: function() {
			var client = window.ifrauclient({
				syncFont: false,
				syncLang: false,
				resizeFrame: false
			});
			this.editorReady = client.connect().then(function() {
				return this._configureTinyMce(client);
			}.bind(this));
		},

		ready: function() {
			// `ready` is called after all elements have been configured, but
			// propagates bottom-up. This element's children are ready, but parents
			// are not.
			//
			// This is the point where you should make modifications to the DOM (when
			// necessary), or kick off any processes the element wants to perform.
		},

		attached: function() {
			// `attached` fires once the element and its parents have been inserted
			// into a document.
			//
			// This is a good place to perform any work related to your element's
			// visual state or active behavior (measuring sizes, beginning animations,
			// loading resources, etc).

			this.initialize();
			this.fire('d2l-html-editor-attached');
		},

		detached: function() {
			// The analog to `attached`, `detached` fires when the element has been
			// removed from a document.
			//
			// Use this to clean up anything you did in `attached`.
			this.cleanup();
		},

		_addPlugin: function(client, plugin) {
			var d2lEditor = this;
			if (plugin.simpleInit) {
				plugin.init();
				return;
			}
			return client.getService(plugin.serviceId, '0.1').then(function(service) {
				return service.config();
			}).then(function(config) {
				if (!config.isEnabled) {
					// Add empty plugin so that we don't have to conditionally set the plugin list - maybe fix later
					tinymce.PluginManager.add(plugin.id, function() {   // eslint-disable-line no-undef
					});
				} else {
					tinymce.PluginManager.add(plugin.id, function(editor) {   // eslint-disable-line no-undef
						editor.addButton(plugin.id, {
							tooltip: plugin.label,
							icon: plugin.icon,
							onclick: function() {
								d2lEditor._callService(client, plugin.serviceId, editor, plugin.cmd);
							}
						});

						plugin.init(editor, config);
					});
				}
			}).catch(function() {
			});
		},

		_configurePlugins: function(client) {
			var pluginDefinitions = this.behaviors.map(function(behavior) {
				return behavior.plugin;
			});

			var plugins = [];
			pluginDefinitions.forEach(function(plugin) {
				if (plugin) {
					plugins.push(this._addPlugin(client, plugin));
				}
			}, this);
			return plugins;
		},

		_configureTinyMce: function(client) {
			var plugins = this._configurePlugins(client);
			return Promise.all(plugins);  // eslint-disable-line no-undef
		},

		_callService: function(client, serviceId, editor, fn) {
			client.getService(serviceId, '0.1').then(function(service) {
				fn.call(null, service, editor);
			});
		},

		initialize: function() {
			this.editorReady.then(function() {
				this._init();
			}.bind(this));
		},

		// We cannot cleanup in detached because React seems to cause the web component
		// to detach/attach during move operations
		cleanup: function() {
			tinymce.EditorManager.execCommand('mceRemoveEditor', true, this.editorId); // eslint-disable-line no-undef
			this.client = null;
		},

		focus: function() {
			tinymce.EditorManager.get(this.editorId).focus(); // eslint-disable-line no-undef
		},

		getContent: function() {
			return tinymce.EditorManager.get(this.editorId).getContent(); // eslint-disable-line no-undef
		},

		_init: function() {
			if (null !== this.baseUrl) {
				tinyMCE.baseURL = this.baseUrl; // eslint-disable-line
			}

			// In React 15 Polymer dom APIs for distributed light DOM children
			// seem to be broken - this will probably not work in Shadow DOM
			// this.element = Polymer.dom(this).querySelector('#' + this.editorId);
			this.element = this.querySelector('#' + this.editorId);
			this.element.style.overflowY = 'auto';
			this.element.style.minHeight = this.minHeight;
			this.element.style.maxHeight = this.maxHeight;

			this._initTinyMCE();
		},

		/**
		 * Init tinyMCE
		 * @private
		 */
		_initTinyMCE: function() {
			var that = this;
			var config = {
				selector: '#' + this.editorId,
				plugins: 'd2l_image d2l_isf d2l_link paste autolink table fullscreen directionality hr textcolor colorpicker code charmap link lists d2l_formatrollup d2l_textstylerollup d2l_insertrollup',
				toolbar: this.inline ? 'bold italic underline d2l_image d2l_isf equation fullscreen' : 'bold italic underline d2l_textstylerollup | d2l_isf d2l_image d2l_link d2l_insertrollup | equation | bullist d2l_formatrollup | table | forecolor | styleselect | fontselect fontsizeselect | undo redo | cut paste | code | smallscreen',
				fontsize_formats: '8pt 10pt 12pt 14pt 18pt 24pt 36pt',
				style_formats: [
								{title: "Paragraph",format: "p"},
								{title: "Address",format: "address"},
								{title: "Preformatted",format: "pre"},
								{title: "Header 1",format: "h1"},
                                {title: "Header 2",format: "h2"},
                                {title: "Header 3",format: "h3"},
                                {title: "Header 4",format: "h4"},
                                {title: "Header 5",format: "h5"},
                                {title: "Header 6",format: "h6"}
								],
				auto_focus: this.autoFocus ? this.editorId : null,
				menubar: false,
				statusbar: false,
				fixed_toolbar_container: '#' + this.toolbarId,
				inline: this.inline ? true : false,
				document_base_url: this.documentBaseUrl + '/',
				content_css: this.cssUrl + ',' + this.appRoot + 'bower_components/d2l-html-editor/d2l-insertstuff.css',
				convert_urls: false,
				relative_urls: false,
				setup: function(editor) {
					var equationSetting = 1;
					var equationButton;
					editor.on('init', function() {
						if (that.content) {
							editor.setContent(decodeURIComponent(that.content));
							// After initial initialization, clear content. The web component may become
							// detached due to React reordering.  This will cause a re-init, but we want
							// it to re-init from the current content.  We will look at preventing
							// initialization on attach/detach in future.  However, detach is currently
							// the simplest place to clean up the TinyMCE editor.  Probably should include
							// a property to auto clean up, otherwise would need to explicitly call a clean
							// up method from React componentWillUnmount.
							that.content = null;
						}
					});

					editor.on('change', function() {
						that.fire('change', {content: editor.getContent()});
					});

					editor.on('focusin', function(e) {
						that.fire('focus', e);
					});

					editor.on('focusout', function(e) {
						that.fire('blur', e);
					});

					editor.on('keyup', function() {
						// that.element.value = editor.getContent();
					});

					editor.addMenuItem('graphical_editor', {
						icon: 'd2l_graphical_equation',
						text: 'Graphical equation',
						onclick: function() {
							if (equationSetting !== 1) {
								equationSetting = 1;
								equationButton.icon('d2l_graphical_equation');
								equationButton.aria('label', 'Graphical Equation Selected - Equation Editor');
							}
						}
					});

					editor.addMenuItem('mml_editor', {
						icon: 'd2l_mml',
						text: 'MathML equation',
						onclick: function() {
							if (equationSetting !== 2) {
								equationSetting = 2;
								equationButton.icon('d2l_mml');
								equationButton.aria('label', 'MathML Equation Selected - Equation Editor');
							}
						}
					});

					editor.addMenuItem('latex_editor', {
						icon: 'd2l_latex',
						text: 'LaTex equation',
						onclick: function() {
							if (equationSetting !== 3) {
								equationSetting = 3;
								equationButton.icon('d2l_latex');
								equationButton.aria('label', 'Latex Equation Selected - Equation Editor');
							}
						}
					});

					editor.addButton('equation', {
						title: 'Graphical Equation Selected - Equation Editor',
						icon: 'd2l_graphical_equation',
						type: 'splitbutton',
						menu: [editor.menuItems['graphical_editor'],
						editor.menuItems['mml_editor'],
						editor.menuItems['latex_editor']],
						onPostRender: function() {
							equationButton = this;
						},
						onclick: function() {
						}
					});

					editor.addButton('fullscreen', {
						title: 'Open in Full Screen Editor',
						icon: 'd2l_fullscreen',
						onclick: function() {
							that.fire('fullscreen');
						}
					});

					editor.addButton('smallscreen', {
						title: 'Close Full Screen Editor',
						icon: 'd2l_smallscreen',
						onclick: function() {
							editor.execCommand('mceFullScreen');
							that.fire('restore');
						}
					});

					if (!this.inline) {
						editor.on('init', function() {
							editor.execCommand('mceFullScreen');
						});
					}
				}
			};

			tinymce.init(config); // eslint-disable-line no-undef

			// need to reset auto focus property to prevent unwanted focus during re-ordering of the options
			this.autoFocus = 0;
		},

		computeToolbarId: function(editorId) {
			return editorId + '-toolbar';
		},

		computeHeight: function(totalPadding, rows, lineHeight) {
			return totalPadding + (lineHeight * rows) + 'rem';
		}
	});

</script>
